pkgname=('openvpn-unprivileged-git')
srcname='openvpn'
pkgver='1'
pkgrel='1'
pkgdesc='A Secure tunneling daemon; Customized for running as unprivileged container'
arch=('i686' 'x86_64')
url='https://github.com/OpenVPN/openvpn'
license=('custom')

depends=('openssl' 'lzo' 'iproute2')
makedepends=('git')
provides=('openvpn')
conflicts=('openvpn')

source=(
    "$srcname::git+https://github.com/OpenVPN/openvpn.git#tag=v2.3.6"
    'tunsetiff.patch'
)
sha512sums=(
    'SKIP'
    'b979ff1f5e1b6c1156f27a8ea766fc26378b359e69bd900d40577fb8b9850a0e364fcc140434cdddb2e3edd9fa1e02bccaaefdc0709e92ac39b01c86d8f24516'
)

pkgver() {
    cd "$srcdir/$srcname"

    printf 'r%s.%s\n' \
        "$(git rev-list HEAD | wc --lines)" \
        "$(git describe --always | sed 's/-/./g')"
}

prepare() {
    cd "$srcdir/$srcname"

    git apply "$srcdir/tunsetiff.patch"
}

build() {
    cd "$srcdir/$srcname"

    autoreconf --install --verbose --force

    CFLAGS="$CFLAGS -DPLUGIN_LIBDIR=\\\"/usr/lib/openvpn\\\"" ./configure \
        --prefix=/usr \
        --sbindir=/usr/bin \
        --mandir=/usr/share/man \
        --enable-iproute2

    make
}

package() {
    cd "$srcdir/$srcname"

    make DESTDIR="$pkgdir" install
}
